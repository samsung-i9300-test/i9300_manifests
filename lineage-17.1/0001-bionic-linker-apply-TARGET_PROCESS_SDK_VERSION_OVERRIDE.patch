From bfdbce73bc96028f0deb25c003d9a8ab4c73894e Mon Sep 17 00:00:00 2001
From: Dominggoes Isakh <drjisakh@gmail.com>
Date: Tue, 10 Dec 2019 22:34:55 +0100
Subject: [PATCH] linker: Apply TARGET_PROCESS_SDK_VERSION_OVERRIDE on dlopen

Change-Id: I2d93f81315fcb67cc3fd102f45d9db8f84e2ff12
---
 linker/linker.cpp | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/bionic/linker/linker.cpp b/bionic/linker/linker.cpp
index 6941fde20a..8c3e38d637 100644
--- a/bionic/linker/linker.cpp
+++ b/bionic/linker/linker.cpp
@@ -3973,6 +3973,17 @@ bool soinfo::link_image(const soinfo_list_t& global_group, const soinfo_list_t&
   if (has_text_relocations) {
     // Fail if app is targeting M or above.
     int app_target_api_level = get_application_target_sdk_version();
+#ifdef SDK_VERSION_OVERRIDES
+    for (const auto& entry : android::base::Split(SDK_VERSION_OVERRIDES, " ")) {
+      auto splitted = android::base::Split(entry, "=");
+      if (splitted.size() == 2 && splitted[0] == get_realpath()) {
+        app_target_api_level = static_cast<uint32_t>(std::stoul(splitted[1]));
+        DEBUG("\"%s\" has text relocations. Overriding sdk version %d to %d", get_realpath(), get_application_target_sdk_version(), app_target_api_level);
+        break;
+      }
+    }
+#endif
+
     if (app_target_api_level >= __ANDROID_API_M__) {
       DL_ERR_AND_LOG("\"%s\" has text relocations (https://android.googlesource.com/platform/"
                      "bionic/+/master/android-changes-for-ndk-developers.md#Text-Relocations-"
